generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Restaurant {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  ownerName   String
  email       String
  phone       String
  username    String     @unique @default(cuid())
  password    String     @default("123456")
  isActive    Boolean    @default(true)
  businessType String    @default("restaurant") // "restaurant" or "hotel"
  
  // Settings
  address     String?
  logoUrl     String?
  taxEnabled  Boolean    @default(true)
  taxPercentage Float    @default(5.0)
  deliveryChargesEnabled Boolean @default(true)
  deliveryCharges Float  @default(40.0)
  deliveryFreeThreshold Float @default(500.0)
  
  // Order Preferences
  dineInEnabled Boolean @default(true)
  takeawayEnabled Boolean @default(true)
  deliveryEnabled Boolean @default(true)
  requireTableNumber Boolean @default(true)
  
  // Trial
  trialEndDate DateTime?
  
  // AI Config
  aiUpsellEnabled Boolean @default(true)
  
  // AI Flash Popups Config
  aiUpsellPopupEnabled Boolean @default(false)
  popupMode          String  @default("MANUAL") // "MANUAL" or "AI"
  popupItem1Id       String?
  popupItem2Id       String?
  popup1Text         String?
  popup2Text         String?
  
  // Advanced AOV Tracking & Marketing Config
  giftThreshold      Float?
  giftItemId         String?
  aiMarketingEnabled Boolean @default(true)
  maxAiDiscountPct   Float   @default(15.0)
  mysteryBoxEnabled  Boolean @default(false)
  mysteryBoxPrice    Float   @default(49.0)
  mysteryBoxItemIds  String? // JSON array of menu item IDs for the mystery box pool
  
  createdAt   DateTime   @default(now())
  categories  Category[]
  menuItems   MenuItem[]
  orders      Order[]
  notifications Notification[]
  banners     Banner[]
  marketingRules MarketingRule[]
}

model Banner {
  id           String     @id @default(cuid())
  restaurantId String
  imageUrl     String
  title        String?
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
}

model Category {
  id           String     @id @default(cuid())
  restaurantId String
  name         String
  icon         String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuItems    MenuItem[]
}

model MenuItem {
  id           String        @id @default(cuid())
  restaurantId String
  name         String
  description  String?
  fullPrice    Float
  halfPrice    Float?
  categoryId   String
  imageUrl     String?
  isVeg        Boolean       @default(true)
  isAvailable  Boolean       @default(true)
  recommendedItemIds String? // Pre-computed AI Upsell recommendations (JSON array string)
  category     Category      @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  restaurant   Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  OrderDetails OrderDetail[]
  marketingRulesAsTrigger MarketingRule[] @relation("TriggerItem")
  marketingRulesAsTarget  MarketingRule[] @relation("TargetItem")
}

model Order {
  id             String        @id @default(cuid())
  restaurantId   String
  customerName   String
  customerPhone  String?       @default("0000000000")
  totalAmount    Float
  status         String        @default("PENDING")
  orderType      String        @default("dine-in")
  tableNumber    String?
  address        String?
  paymentStatus  String        @default("pending")
  createdAt      DateTime      @default(now())
  restaurant     Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  details        OrderDetail[]
}

model OrderDetail {
  id         String   @id @default(cuid())
  orderId    String
  menuItemId String
  quantity   Int
  price      Float
  portion    String?  @default("full")
  isUpsell   Boolean  @default(false)
  marketingSource String? // POPUP, MYSTERY_BOX, CROSS_SELL, COMBO
  marketingRuleId String? // ID of the MarketingRule that triggered this
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
}

model Notification {
  id           String     @id @default(cuid())
  restaurantId String
  tableNumber  String
  type         String     @default("WAITER_CALL") // WAITER_CALL, BILL_REQUEST
  status       String     @default("pending")     // pending, resolved
  createdAt    DateTime   @default(now())
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
}

model MarketingRule {
  id             String     @id @default(cuid())
  restaurantId   String
  type           String     // CROSS_SELL, UP_SELL, IMPULSE, COMBO, MYSTERY_BOX, POPUP
  triggerItemId  String?    // item that triggers this rule
  targetItemId   String?    // item to recommend (null if AI decides dynamically)
  discountPct    Float      @default(0.0)
  isActive       Boolean    @default(true)
  isAiManaged    Boolean    @default(false)
  createdAt      DateTime   @default(now())

  restaurant     Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  triggerItem    MenuItem?  @relation("TriggerItem", fields: [triggerItemId], references: [id])
  targetItem     MenuItem?  @relation("TargetItem", fields: [targetItemId], references: [id])
}
